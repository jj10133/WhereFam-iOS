name: WhereFam
include:
  - app/addons/addons.yml

packages:
  ConcentricOnboarding:
    url: https://github.com/exyte/ConcentricOnboarding.git
    from: 1.1.1
  BareKit:
    url: https://github.com/holepunchto/bare-kit-swift
    branch: main
  swiftui-dsl:
    url: https://github.com/maplibre/swiftui-dsl
    branch: main
  purchases-ios-spm:
    url: https://github.com/RevenueCat/purchases-ios
    from: 5.34.0

targets:
  App:
    type: application
    platform: iOS
    deploymentTarget: 17.0
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: com.wherefam.ios
        SWIFT_VERSION: 5.0
        ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS: YES
        DEVELOPMENT_TEAM: ${DEVELOPMENT_TEAM}
        CODE_SIGN_STYLE: Automatic
        OTHER_LDFLAGS: "$(inherited) -weak_framework SwiftUICore"

    info:
      path: app/Info.plist
      properties:
        CFBundleDisplayName: "WhereFam"
        CFBundleShortVersionString: "1.0.0"
        CFBundleVersion: "1"
        NSLocationWhenInUseUsageDescription: We would like to access location for sharing to other members
        NSLocationAlwaysAndWhenInUseUsageDescription: We would like to access location for sharing to other members
        UILaunchScreen: app/Assets.xcassets/AppIcon.appIconset
        UIBackgroundModes:
          - location
        NSLocalNetworkUsageDescription: "We need access to your local network to connect to nearby devices."
        NSAppTransportSecurity:
          NSAllowsArbitraryLoads: true 

    entitlements:
      path: app/WhereFam.entitlements
      properties:
        aps-environment: development
        com.apple.security.application-groups:
          - group.com.wherefam.ios
        com.apple.security.cs.allow-jit: true

    capabilities:
      - inAppPurchase: true
      - pushNotifications: true 

    appIcon: app/Assets.xcassets/AppIcon.appIconset
    dependencies:
      - package: ConcentricOnboarding
      - package: BareKit
      - framework: app/frameworks/BareKit.xcframework
      - target: NotificationServiceExtension
      - package: swiftui-dsl
        product: MapLibreSwiftDSL
        product: MapLibreSwiftUI
      - package: purchases-ios-spm
        product: RevenueCat
        product: RevenueCatUI

    sources:
      - path: app/App.swift
      - path: app/AppDelegate.swift
      - path: app/app.bundle
      - path: app/Assets.xcassets
      - path: app/NotificationService.swift
      - path: app/push.bundle
      - path: app/style.json
      - path: app/WhereFam.storekit

      - path: app/Core/Root/ContentView.swift
        group: app/Core/Root

      - path: app/Core/Home/View/PeopleView.swift
        group: app/Core/Home/View
      - path: app/Core/Home/View/HomeView.swift
      - path: app/Core/Home/View/ProvideFeedbackView.swift
      - path: app/Core/Home/View/ShareIDView.swift
      - path: app/Core/Home/View/SimpleMapView.swift

      - path: app/Core/Onboarding/View/FifthPageView.swift
        group: app/Core/Onboarding/View
      - path: app/Core/Onboarding/View/FirstPageView.swift
      - path: app/Core/Onboarding/View/FourthPageView.swift
      - path: app/Core/Onboarding/View/SecondPageView.swift
      - path: app/Core/Onboarding/View/SixthPageView.swift
      - path: app/Core/Onboarding/View/ThirdPageView.swift

      - path: app/Core/IPC/IPCViewModel.swift
        group: app/Core/IPC
      - path: app/Core/IPC/Worker.swift

      - path: app/js/app.js
        group: app/js
      - path: app/js/push.js
      - path: app/js/constants.js
      - path: app/js/hyperbee-manager.js
      - path: app/js/hyperswarm-manager.js
      - path: app/js/map-manager.js
      - path: app/js/ipc.js
      - path: app/js/location-manager.js

      - path: app/Manager/LocationManager.swift
        group: app/Manager

      - path: app/Models/People.swift
        group: app/Models

    scheme:
      preActions:
        - name: Link
          script: |
            PATH="${PATH}" "${PWD}/node_modules/.bin/bare-link" \
              --preset ios\
              --out ${PWD}/app/addons \
              ${PWD}
        - name: Pack
          script: |
            PATH="${PATH}" "${PWD}/node_modules/.bin/bare-pack" \
              --preset ios\
              --base ${PWD} \
              --out ${PWD}/app/app.bundle \
              ${PWD}/app/js/app.js
            PATH="${PATH}" "${PWD}/node_modules/.bin/bare-pack" \
              --preset ios\
              --base ${PWD} \
              --out ${PWD}/app/push.bundle \
              ${PWD}/app/js/push.js

  NotificationServiceExtension:
    type: app-extension
    platform: iOS
    deploymentTarget: 17.0
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: com.wherefam.ios.NotificationServiceExtension
        SWIFT_VERSION: 5.0
    info:
      path: app/NotificationServiceExtension.Info.plist
      properties:
        NSExtension:
          NSExtensionPointIdentifier: com.apple.usernotifications.service
          NSExtensionPrincipalClass: NotificationServiceExtension.NotificationService
    entitlements:
      path: app/NotificationServiceExtension.entitlements
      properties:
        com.apple.security.application-groups:
          - group.com.wherefam.ios
        # com.apple.developer.usernotifications.filtering: true
    dependencies:
      - framework: app/frameworks/BareKit.xcframework
      - package: BareKit
    sources:
      - path: app/NotificationService.swift
      - path: app/js/push.js
      - path: app/push.bundle
        optional: true
